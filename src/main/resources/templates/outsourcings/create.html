<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>외주 생성</title>
    <!-- <link rel="shortcut icon" type="image/x-icon" href="img/favicon.ico"> -->

    <!-- css -->
    <link rel="stylesheet" href="/css/reset.css">
    <link rel="stylesheet" href="/css/content.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/component.css">
    <!-- //css -->

    <!-- script -->
    <script src="/js/jquery-1.11.3.min.js"></script>
    <script src="/js/jquery.easing.1.3.js"></script>
    <!-- //script -->
</head>
<body>

<header>
    <h1>외주 생성</h1>
</header>

<main>
    <form id="outsourcingForm" enctype="multipart/form-data">
        <!-- 랜덤 데이터 채우기 버튼 -->
        <button type="button" onclick="fillRandomData()">랜덤 데이터 채우기</button>

        <section>
            <h2>기본 정보</h2>
            <label for="title">제목:</label>
            <input type="text" id="title" name="title" required />

            <label for="content">설명:</label>
            <textarea id="content" name="content" required></textarea>
        </section>

        <section>
            <h2>상세 정보</h2>
            <label for="preferential">우대 사항:</label>
            <input type="text" id="preferential" name="preferential" required />

            <label for="work_type">작업 유형:</label>
            <input type="text" id="work_type" name="work_type" required />

            <label for="price">예산:</label>
            <input type="number" id="price" name="price" min="10000" required />
        </section>

        <section>
            <h2>일정 정보</h2>
            <label for="recruit_start_date">모집 시작 날짜:</label>
            <input type="date" id="recruit_start_date" name="recruit_start_date" required />

            <label for="recruit_end_date">모집 종료 날짜:</label>
            <input type="date" id="recruit_end_date" name="recruit_end_date" required />

            <label for="work_start_date">작업 시작 날짜:</label>
            <input type="date" id="work_start_date" name="work_start_date" required />

            <label for="work_end_date">작업 종료 날짜:</label>
            <input type="date" id="work_end_date" name="work_end_date" required />
        </section>

        <section>
            <h2>지역 및 파일 업로드</h2>
            <label for="area">지역:</label>
            <select id="area" name="area" required>
                <option value="" disabled selected>지역 선택</option>
                <option th:each="area : ${T(com.sparta.doguin.domain.outsourcing.constans.AreaType).values()}"
                        th:value="${area.name()}"
                        th:text="${area.description}">지역 선택</option>
            </select>

            <label for="files">파일 업로드:</label>
            <input type="file" id="files" name="files" multiple />
        </section>

        <div style="text-align: center; margin-top: 1.5em;">
            <button type="button" onclick="submitForm()">외주 생성</button>
        </div>
    </form>
</main>

<footer style="text-align: center; margin-top: 2em;">
    <p>&copy; 2024 외주 플랫폼. 모든 권리 보유.</p>
</footer>

<script>
    const token = "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIyIiwiZW1haWwiOiJ0ZXN0MUBuYXZlci5jb20iLCJuaWNrbmFtZSI6IuqzoOq1rOuniCIsInVzZXJUeXBlIjoiQ09NUEFOWSIsInVzZXJSb2xlIjoiUk9MRV9BRE1JTiIsImV4cCI6MTczMDk1ODE3MSwiaWF0IjoxNzMwOTU0NTcxfQ.hC16fx70ggs0lUElfuqGV3dULxjzAC1aJFOZCI_iPlQ";
    // 랜덤 데이터 채우기 함수
    function fillRandomData() {
        document.getElementById("title").value = "랜덤 프로젝트 제목 " + Math.floor(Math.random() * 100);
        document.getElementById("content").value = "이것은 랜덤 설명입니다. 예시 텍스트를 사용하고 있습니다.";
        document.getElementById("preferential").value = "우대사항 예시";
        document.getElementById("work_type").value = "프리랜서";
        document.getElementById("price").value = Math.floor(Math.random() * 50000) + 10000;

        const today = new Date();
        document.getElementById("recruit_start_date").value = new Date(today).toISOString().split('T')[0];
        document.getElementById("recruit_end_date").value = new Date(today.setDate(today.getDate() + 10)).toISOString().split('T')[0];
        document.getElementById("work_start_date").value = new Date(today.setDate(today.getDate() + 5)).toISOString().split('T')[0];
        document.getElementById("work_end_date").value = new Date(today.setDate(today.getDate() + 20)).toISOString().split('T')[0];

        const areaOptions = document.getElementById("area").options;
        areaOptions[Math.floor(Math.random() * (areaOptions.length - 1)) + 1].selected = true;
    }

    function submitForm() {
        const form = document.getElementById("outsourcingForm");
        const formData = new FormData();

        // 모든 form input 요소를 객체로 수집하면서, LocalDateTime에 맞게 포맷 변경
        const outsourcingRequestCreateData = {};
        new FormData(form).forEach((value, key) => {
            if (key === 'recruit_start_date' || key === 'recruit_end_date' ||
                key === 'work_start_date' || key === 'work_end_date') {
                // 날짜를 "YYYY-MM-DDT00:00:00" 형식으로 변환
                outsourcingRequestCreateData[key] = `${value}T00:00:00`;
            } else if (key !== 'files') {
                outsourcingRequestCreateData[key] = value;
            }
        });

        // JSON 문자열로 변환
        const outsourcingRequestCreateJSON = JSON.stringify(outsourcingRequestCreateData);

        // JSON 데이터를 Blob으로 생성
        const outsourcingRequestCreateBlob = new Blob([outsourcingRequestCreateJSON], { type: 'application/json' });

        // outsourcingRequestCreate 파트로 Blob 추가
        formData.append('outsourcingRequestCreate', outsourcingRequestCreateBlob);

        // 파일 추가
        const filesInput = document.getElementById('files');
        if (filesInput.files.length > 0) {
            for (let i = 0; i < filesInput.files.length; i++) {
                formData.append('files', filesInput.files[i]);
            }
        }

        fetch("http://localhost:8080/outsourcings", {
            method: "POST",
            headers: {
                "Authorization": token
            },
            body: formData
        })
            .then(response => {
                if (response.ok) {
                    alert("외주 생성 성공!");
                    window.location.href = `/outsourcings/list`; // 수정된 외주 상세 페이지로 이동
                } else {
                    response.json().then(data => {
                        alert("외주 생성 실패: " + (data.message || response.statusText));
                    });
                }
            })
            .catch(error => {
                console.error("에러 발생:", error);
                alert("서버 오류");
            });
    }

</script>

</body>
</html>
